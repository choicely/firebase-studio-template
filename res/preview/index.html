<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Choicely Preview</title>
    <style>
        :root {
          --focus: #37ff95;
          --fg: #d9e6e0;
          --fg-strong: #e6f6f0;
          --muted: #6a7671;

          --bg: #0b0f0e;
          --panel: #0e1211;
          --sidebar: #0d1211;
          --frame: #0f1413;
          --border: #101514;

          --sel: #37ff9526;
          --sel-2: #37ff951a;
          --line: #37ff950f;

          --page-pad: clamp(12px, 3vh, 28px);
          --phone-w: min(420px, calc(100vw - (var(--page-pad) * 2)));
          --header-gap: 12px;
          --phone-h: calc(100dvh - (var(--page-pad) * 2) - 96px);
          --phone-radius: 34px;
          --bezel: 12px;

          --shadow: 0 24px 80px rgba(0, 0, 0, .55);
          --bezel-edge: rgba(255, 255, 255, .10);
        }

        *,
        *::before,
        *::after {
          box-sizing: border-box;
        }

        html,
        body {
          height: 100%;
          margin: 0;
        }

        body {
          height: 100dvh;
          overflow: hidden;
          overscroll-behavior: none;

          display: grid;
          place-items: center;
          padding: var(--page-pad);

          color: var(--fg);
          background-color: var(--bg);
          background-image:
            radial-gradient(900px 700px at 50% 15%, rgba(55, 255, 149, .10), transparent 55%),
            radial-gradient(1100px 800px at 20% 90%, rgba(55, 255, 149, .06), transparent 60%),
            linear-gradient(180deg, rgba(255, 255, 255, .02), transparent 30%);
          background-repeat: no-repeat;
          background-size: cover;
          background-position: center;
          background-attachment: fixed;

          font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }

        .stack {
          width: var(--phone-w);
          display: flex;
          flex-direction: column;
          gap: var(--header-gap);
          align-items: stretch;
        }

        .header {
          text-align: center;
          color: rgba(217, 230, 224, .95);
          font: 500 14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }

        .header h1 {
          margin: 0 0 6px;
          font-size: clamp(18px, 2.2vw, 26px);
          font-weight: 780;
          letter-spacing: -0.02em;
          color: var(--fg-strong);
          text-shadow: 0 0 18px rgba(55, 255, 149, .10);
        }

        .header p {
          margin: 0;
          color: rgba(217, 230, 224, .78);
        }

        .actions {
          display: flex;
          justify-content: center;
          margin-top: 10px;
        }

        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 10px 14px;
          border-radius: 14px;
          text-decoration: none;

          background: var(--focus);
          color: var(--bg);
          font: 750 14px/1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

          border: 1px solid rgba(0, 0, 0, .20);
          box-shadow:
            0 10px 30px rgba(0, 0, 0, .35),
            0 0 0 1px rgba(55, 255, 149, .20);

          transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
          user-select: none;
          -webkit-tap-highlight-color: transparent;
        }

        .btn:hover {
          filter: brightness(1.03);
          transform: translateY(-1px);
          box-shadow:
            0 12px 34px rgba(0, 0, 0, .40),
            0 0 0 2px rgba(55, 255, 149, .22);
        }

        .btn:active {
          transform: translateY(0px);
        }

        .btn:focus-visible {
          outline: 2px solid var(--focusBorder, var(--focus));
          outline-offset: 3px;
        }

        .phone {
          width: 100%;
          height: var(--phone-h);
          max-height: 900px;

          border-radius: var(--phone-radius);
          background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
          box-shadow: var(--shadow);
          position: relative;
          padding: var(--bezel);

          border: 1px solid var(--border);
          background-color: rgba(14, 18, 17, .35);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        }

        .screen {
          height: 100%;
          width: 100%;
          border-radius: calc(var(--phone-radius) - var(--bezel));
          overflow: hidden;
          background: #000;
          border: 1px solid rgba(255, 255, 255, .08);
          position: relative;
        }

        iframe {
          display: block;
          border: 0;
          width: 100%;
          height: 100%;
          background: #000;
        }

        .error,
        .error * {
          color: var(--fg-strong);
        }

        .error {
          position: absolute;
          inset: 0;
          display: none;
          align-items: center;
          justify-content: center;
          padding: 28px;
          text-align: center;
          z-index: 2;

          background:
            radial-gradient(800px 500px at 50% 30%, rgba(55, 255, 149, .10), transparent 60%),
            rgba(11, 15, 14, .92);
          font: 650 14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }

        .error .box {
          max-width: 340px;
          border: 1px solid rgba(55, 255, 149, .22);
          border-radius: 16px;
          padding: 16px 14px;
          background: rgba(14, 18, 17, .55);
          box-shadow:
            0 10px 30px rgba(0, 0, 0, .45),
            0 0 0 1px rgba(16, 21, 20, .90);
        }

        .error .title {
          font-size: 15px;
          margin: 0 0 8px;
          letter-spacing: -0.01em;
        }

        .error code {
          font-weight: 800;
          background: var(--sel);
          color: var(--focus);
          padding: 2px 6px;
          border-radius: 8px;
          border: 1px solid rgba(55, 255, 149, .22);
        }

        .error .hint {
          opacity: .86;
          margin: 0;
          color: rgba(217, 230, 224, .85);
        }

        @media (max-width: 380px) {
          :root {
            --phone-radius: 26px;
            --bezel: 10px;
            --phone-h: calc(100dvh - (var(--page-pad) * 2) - 90px);
          }
        }

        *,
        *::before,
        *::after {
          box-sizing: border-box;
        }

        /* Actions row: two buttons */
        .actions {
          display: flex;
          justify-content: center;
          gap: 10px;
          margin-top: 10px;
          flex-wrap: wrap;
        }

        /* Secondary button style */
        .btn.secondary {
          background: rgba(217, 230, 224, .06);
          color: var(--fg-strong);
          border: 1px solid rgba(255, 255, 255, .12);
          box-shadow:
            0 10px 30px rgba(0, 0, 0, .30),
            0 0 0 1px rgba(16, 21, 20, .90);
        }

        .btn.secondary:hover {
          filter: brightness(1.05);
          box-shadow:
            0 12px 34px rgba(0, 0, 0, .38),
            0 0 0 1px rgba(55, 255, 149, .12);
        }

        /* QR overlay */
        .qr-overlay {
          position: fixed;
          inset: 0;
          display: none;
          align-items: center;
          justify-content: center;
          padding: var(--page-pad);
          z-index: 999;
        }

        .qr-overlay[aria-hidden="false"] {
          display: flex;
        }

        .qr-backdrop {
          position: absolute;
          inset: 0;
          background: rgba(11, 15, 14, .55);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
        }

        .qr-modal {
          position: relative;
          z-index: 1;
          width: min(520px, calc(100vw - (var(--page-pad) * 2)));
          border-radius: 18px;
          border: 1px solid rgba(55, 255, 149, .22);
          background: rgba(14, 18, 17, .72);
          box-shadow:
            0 24px 80px rgba(0, 0, 0, .55),
            0 0 0 1px rgba(16, 21, 20, .90);
          padding: 16px;
        }

        .qr-close {
          position: absolute;
          top: 10px;
          right: 10px;
          width: 38px;
          height: 38px;
          border-radius: 12px;
          border: 1px solid rgba(255, 255, 255, .12);
          background: rgba(217, 230, 224, .06);
          color: var(--fg-strong);
          cursor: pointer;
          display: grid;
          place-items: center;
          font: 800 16px/1 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }

        .qr-close:hover {
          filter: brightness(1.08);
        }

        .qr-title {
          margin: 0 44px 12px 0;
          font: 700 14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
          color: rgba(217, 230, 224, .92);
        }

        .qr-img {
          display: block;
          width: min(360px, 100%);
          height: auto;
          margin: 0 auto;
          border-radius: 14px;
          border: 1px solid rgba(255, 255, 255, .10);
          background: rgba(0, 0, 0, .25);
        }

        .qr-status {
          display: flex;
          align-items: center;
          gap: 10px;
          margin: 0 0 12px 0;
          color: rgba(217, 230, 224, .88);
          font: 650 13px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }

        .spinner {
          width: 16px;
          height: 16px;
          border-radius: 999px;
          border: 2px solid rgba(217, 230, 224, .22);
          border-top-color: rgba(55, 255, 149, .95);
          animation: spin 0.9s linear infinite;
          flex: 0 0 auto;
        }

        @keyframes spin {
          to {
            transform: rotate(360deg);
          }
        }

        [hidden] {
          display: none !important;
        }
    </style>
</head>

<body>
<div class="stack">
    <div class="header">
        <h1>Preview your Choicely mobile app</h1>
        <p>Scan the QR code to preview on a real device.</p>
        <div class="actions">
            <a id="showQr" class="btn secondary" href="#" role="button">
                Show QR
            </a>

            <a class="btn" href="https://studio.choicely.com" target="_blank" rel="noopener noreferrer">
                Open in Choicely Studio
            </a>
        </div>
    </div>

    <div class="phone" role="region" aria-label="Phone preview frame">
        <div class="screen">
            <div id="err" class="error" role="alert" aria-live="polite">
                <div class="box">
                    <p class="title">Missing <code>CHOICELY_APP_KEY</code></p>
                    <p class="hint">config.js was not generated (or it still contains the placeholder).</p>
                </div>
            </div>
            <iframe id="w" title="Choicely Widget" allow="fullscreen"></iframe>
        </div>
    </div>
</div>
<div id="qrOverlay" class="qr-overlay" aria-hidden="true" role="dialog" aria-modal="true" aria-label="QR Code">
    <div class="qr-backdrop" data-close="true"></div>

    <div class="qr-modal" role="document">
        <button class="qr-close" type="button" aria-label="Close" data-close="true">Ã—</button>

        <p class="qr-title">
            Scan the QR code on your Android device to download the app on your phone (iOS preview not yet supported).
        </p>

        <div id="qrStatus" class="qr-status">
            <span class="spinner" aria-hidden="true"></span>
            <span id="qrStatusText">Loading QRâ€¦</span>
        </div>

        <img id="qrImg" class="qr-img" src="./qr.png" alt="QR code" hidden />
    </div>
</div>
<script src="./config.js"></script>

<script>
    // 1. Get the App Key safely
    const getQueryParam = (name) => {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    };

    let wak = window.__CHOICELY_APP_KEY__;
    if (!wak || wak === "__CHOICELY_APP_KEY__") {
        wak = getQueryParam('appKey') || getQueryParam('wak');
    }

    const iframe = document.getElementById("w");
    const err = document.getElementById("err");

    // 2. Validate Key and Load Widget
    if (!wak || wak === "__CHOICELY_APP_KEY__") {
      err.style.display = "flex";
      iframe.removeAttribute("src");
      console.error("Missing App Key. Please check config.js or URL parameters.");
    } else {
      // Initial Load
      iframe.src = "https://cdn.choicely.com/vx/widget.html?wak=" + encodeURIComponent(wak);
    }

    const showQrBtn = document.getElementById("showQr");
    const qrOverlay = document.getElementById("qrOverlay");
    const qrImg = document.getElementById("qrImg");
    const qrStatus = document.getElementById("qrStatus");
    const qrStatusText = document.getElementById("qrStatusText");

    const setLoading = (text) => {
      qrStatus.hidden = false;
      qrStatusText.textContent = text;
      qrImg.hidden = true;
    };

    const showImage = () => {
      qrStatus.hidden = true;
      qrImg.hidden = false;
    };

    const loadQr = () => {
      setLoading("Loading QRâ€¦");
      const url = "./qr.png?t=" + Date.now();
      qrImg.onload = () => showImage();
      qrImg.onerror = () => setLoading("Preparing app download...");
      qrImg.src = url;
    };

    const openQr = () => {
      qrOverlay.setAttribute("aria-hidden", "false");
      document.addEventListener("keydown", onKeydown);
      loadQr();
    };

    const closeQr = () => {
      qrOverlay.setAttribute("aria-hidden", "true");
      document.removeEventListener("keydown", onKeydown);
    };

    const onKeydown = (e) => {
      if (e.key === "Escape") closeQr();
    };

    showQrBtn.addEventListener("click", (e) => {
      e.preventDefault();
      openQr();
    });

    qrOverlay.addEventListener("click", (e) => {
      const t = e.target;
      if (t && t.getAttribute && t.getAttribute("data-close") === "true") {
        closeQr();
      }
    });

    // --- Real-time Updates ---
    class FetchEventSource {
      constructor(url, { headers = {} } = {}) {
        this.url = url;
        this.headers = headers;
        this.controller = new AbortController();
        this.init();
      }
      
      _safeCallback(name, event) {
          if (this[name]) this[name](event);
      }

      async init() {
        try {
          const response = await fetch(this.url, {
            headers: this.headers,
            signal: this.controller.signal
          });
          
          if (!response.ok) {
             console.warn(`[Preview] Connection failed: ${response.status}`);
             return;
          }
          
          this._safeCallback('onopen');

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();

            for (let line of lines) {
              if (line.trim().startsWith('data:')) {
                const dataStr = line.trim().slice(5).trimStart();
                try {
                   const data = JSON.parse(dataStr);
                   if (data && (data.path || data.data)) {
                       this._safeCallback('onmessage', { data: JSON.stringify(data) });
                   }
                } catch(e) {}
              }
            }
          }
        } catch (e) { 
            if (!this.controller.signal.aborted) console.warn("[Preview] Listener error:", e); 
        }
      }
    }

    const startRealtimeListener = (key) => {
        if (!key || key.includes('__')) return;
        
        let project = 'choicely-studio'; 
        try {
           const decoded = atob(key);
           const match = decoded.match(/^([^/]+)/);
           if (match) project = match[1];
        } catch(e) {}

        const hostMap = {
            'choicely-eu': window.__CHOICELY_REALTIME_SERVER_PROD__, 
            'choicely-studio': window.__CHOICELY_REALTIME_SERVER_PROD__,
            'choicely-test-eu': window.__CHOICELY_REALTIME_SERVER_TEST__,
        };

        const host = hostMap[project] || window.__CHOICELY_REALTIME_SERVER_PROD__;
        const url = `https://${host}/apps/${key}.json`;
        
        console.log(`[Preview] Listening for updates on: ${host}`);
        
        const eventSource = new FetchEventSource(url, { headers: { Accept: 'text/event-stream' } });
        
        eventSource.onmessage = () => {
            console.log('[Preview] ðŸ”„ Update received. Reloading...');
            const iframe = document.getElementById("w");
            if (iframe && iframe.contentWindow) {
                try {
                    const urlObj = new URL(iframe.src);
                    urlObj.searchParams.set('_t', Date.now());
                    iframe.src = urlObj.toString();
                } catch(e) {
                    iframe.contentWindow.location.reload();
                }
            }
        };
    };

    if (wak && wak !== "__CHOICELY_APP_KEY__") {
        startRealtimeListener(wak);
    }
</script>

</body>

</html>
